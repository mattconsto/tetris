<!DOCTYPE html>
<html>
	<head>
		<title>Tetris</title>
		<style>
			body {background: grey;}
			#canvas {
				position: absolute;
				margin: auto;
				left: 0; right: 0; top: 0; bottom: 0;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		
		<script>
			// Helpers

			var deepclone = function(array) {
				var copy = [];
				for(var index in array) copy[index] = typeof array[index] == "object" ? deepclone(array[index]) : array[index];
				return copy;
			}

			var getRandomInt = function(min, max) {
				return Math.floor(Math.random() * (Math.floor(max) - Math.ceil(min))) + Math.ceil(min); //The maximum is exclusive and the minimum is inclusive
			}

			// State

			var dimensions = {height: 25, width: 9, scale: 25};
			var pallete = ["#111", "cyan", "yellow", "magenta", "red", "lime", "orange", "blue"];

			var alive = Array(dimensions.height);
			var dead = Array(dimensions.height);
			for(var i = 0; i < alive.length; i++) alive[i] = Array(dimensions.width).fill(0);
			for(var i = 0; i < dead.length; i++) dead[i] = Array(dimensions.width).fill(0);

			var shapes = [
				[{x: 0, y: 0}, {x: 1, y: 0}, {x: 2, y: 0}, {x: 3, y: 0}], // Line
				[{x: 0, y: 0}, {x: 0, y: 1}, {x: 1, y: 0}, {x: 1, y: 1}], // Box
				[{x: 0, y: 0}, {x: 0, y: 1}, {x: 1, y: 1}, {x: 0, y: 2}], // T
				[{x: 0, y: 0}, {x: 0, y: 1}, {x: 1, y: 1}, {x: 1, y: 2}], // Slant
				[{x: 1, y: 0}, {x: 1, y: 1}, {x: 0, y: 1}, {x: 0, y: 2}],
				[{x: 0, y: 0}, {x: 0, y: 1}, {x: 0, y: 2}, {x: 1, y: 2}], // L
				[{x: 1, y: 0}, {x: 1, y: 1}, {x: 1, y: 2}, {x: 0, y: 2}],
			];

			var lastUpdate = 0;
			var lastEvent = 0;
			var lostthegame = false;
			var scoreCounter = -1;
			var movementMultiplier = 10;

			var newshape = function() {
				scoreCounter++;

				var randomShape = getRandomInt(0, shapes.length);
				var startposition = {x: Math.round(dimensions.width / 2), y: dimensions.height - 1}

				// Clear alive
				for(var i = 0; i < alive.length; i++) alive[i] = Array(dimensions.width).fill(0);

				for(var i = 0; i < shapes[randomShape].length; i++) {
					alive[startposition.y - shapes[randomShape][i].x][startposition.x - shapes[randomShape][i].y] = randomShape + 1;
				} 
			}

			// Init

			var canvas = document.getElementById("canvas");
			canvas.context = canvas.getContext("2d");
			canvas.width = dimensions.width * dimensions.scale;
			canvas.height = dimensions.height * dimensions.scale + 50;

			newshape();

			var events = function(event) {
				var collision = false;
				var alivecopy = deepclone(alive);

				switch(event.keyCode) {
					case 37: case 65: // left and a
						for(var y = 0; !collision && y < dimensions.height; y++) {
							for(var x = 0; !collision && x < dimensions.width; x++) {
								if(alivecopy[y][x] != 0) {
									if(x == 0 || dead[y][x-1] != 0) {
										collision = true;
										continue;
									}

									alivecopy[y][x-1] = alivecopy[y][x];
									alivecopy[y][x] = 0;
								}
							}
						}

						if(!collision) alive = alivecopy;
						break;
					case 39: case 68: // right and d
						for(var y = dimensions.height - 1; !collision && y >= 0; y--) {
							for(var x =  dimensions.width - 1; !collision && x >= 0; x--) {
								if(alivecopy[y][x] != 0) {
									if(x == dimensions.width - 1 || dead[y][x+1] != 0) {
										collision = true;
										continue;
									}

									alivecopy[y][x+1] = alivecopy[y][x];
									alivecopy[y][x] = 0;
								}
							}
						}

						if(!collision) alive = alivecopy;
						break;
				}
			}

			var update = function() {
				// Lose
				for(var x = 0; !lostthegame && x < dimensions.width; x++) {
					lostthegame = dead[dimensions.height-1][x] != 0;
				}

				if(lostthegame) {
					alert("Game over!");
					location.reload(); // Easier than actually restarting
					return;
				}

				// Movement
				var collision = false;

				var alivecopy = deepclone(alive);

				for(var y = 0; !collision && y < dimensions.height; y++) {
					for(var x = 0; !collision && x < dimensions.width; x++) {
						if(alivecopy[y][x] != 0) {
							if(y == 0 || dead[y-1][x] != 0) {
								collision = true;
								continue;
							}

							alivecopy[y-1][x] = alivecopy[y][x];
							alivecopy[y][x] = 0;
						}
					}
				}

				if(collision) {
					console.log("Dead Piece")
					for(var y = 0; y < dimensions.height; y++) {
						for(var x = 0; x < dimensions.width; x++) {
							if(alive[y][x] != 0) dead[y][x] = alive[y][x];
						}
					}

					newshape();

				} else {
					alive = alivecopy;
				}

				// Row clear
				for(var y = 0; y < dimensions.height; y++) {
					var cleared = true;

					for(var x = 0; cleared && x < dimensions.width; x++) cleared = dead[y][x] != 0;

					if(cleared) {
						scoreCounter += 10;

						for(var i = y+1; i < dimensions.height; i++) dead[i-1] = dead[i];
						dead[dimensions.height] = Array(dimensions.width).fill(0);
					}
				}
			}

			var render = function() {
				canvas.context.clearRect(0, 0, canvas.width, canvas.height);

				for(var y = 0; y < dimensions.height; y++) {
					for(var x = 0; x < dimensions.width; x++) {
						canvas.context.fillStyle = pallete[(alive[y][x] != 0 ? alive : dead)[y][x]];
						canvas.context.strokeRect(x * dimensions.scale, (dimensions.height - 1) * dimensions.scale - y * dimensions.scale, dimensions.scale, dimensions.scale);
						canvas.context.fillRect(x * dimensions.scale, (dimensions.height - 1) * dimensions.scale - y * dimensions.scale, dimensions.scale, dimensions.scale);
					}
				}

				canvas.context.fillStyle = "white";
				canvas.context.font = "25px Courier New";
				canvas.context.fillText("Score: " + scoreCounter, 10, dimensions.height * dimensions.scale + 40)
			}

			var loop = function() {
				if(!lostthegame && Date.now() > lastUpdate + 25 * movementMultiplier) {
					update();
					render();
					lastUpdate = Date.now();
				}

				window.requestAnimationFrame(loop);
			}

			window.addEventListener("keyup", function(event) {if(event.keyCode == 40 || event.keyCode == 83) movementMultiplier = 10;});
			window.addEventListener("keydown", function(event) {if(event.keyCode == 40 || event.keyCode == 83) movementMultiplier = 1;});

			window.addEventListener("keydown", function(event) {
				if(Date.now() > lastEvent + 10 * movementMultiplier) {
					events(event);
					lastEvent = Date.now();
				}
			});

			window.requestAnimationFrame(loop);
		</script>
	</body>
</html>
